## Introduction
Compiling a DNN model is the process of quantizing and converting the model into a format that can be inferred with TIDL. TIDL (and its open source front ends) provides utilities to compile models. The imported artifacts can then be used to run inference.

In addition to what is provided with TIDL, this repository provides igh level utilities for compiling DNN models. These tools include dataset loaders, pre-processing utilities, post-processing utilities and metric computation utilities.


## Usage
[run_benchmarks_pc.sh](../run_benchmarks_pc.sh) is the main script in this repository that does compilation of models and benchmark. Usage is:
```
run_benchmarks_pc.sh <SOC> [-d|--debug] [-h|--help]
```

For example, to run compilation for AM68A, this would be the command:
```
run_benchmarks_pc.sh AM68A
```

It uses parallel processing to compile multiple models in parallel and is especially useful while compiling several models, such as all the models in the Model Zoo. The number of parallel processes used defaults to 16 and is set in [settings_import_on_pc.yaml](../settings_import_on_pc.yaml). Change it to a different value if needed. It can be done by either modifying this settings file or by using the --parallel_processes commandline argument.

The `--debug` flag allows for the attaching of a debugpy debugger to the top level python script. Call the script with `--help` for more information.

**Model compilation can be run only on PC. The EVM/device does not support model compilation. However, the inference of a compiled model can be run on PC or on device.**

## Compiling models in the Model Zoo
* modelartifacts_path* in the [settings_base.yaml](../settings_base.yaml) file indicates the location where the artifacts are generated or expected. It currently points to work_dirs/modelartifacts/<SOC>/
* Each model needs a set of side information for compilation. The [configs module](../configs) in this repository by default to understand this information. 
* But this script can also use a [configs.yaml](https://github.com/TexasInstruments/edgeai-tensorlab/blob/main/edgeai-modelzoo/models/configs.yaml) file (instead of the configs module) by specifying it in the argument --configs_path.


## Running inference / benchmark on *PC* using pre-compiled model artifacts
* For the models in the Model Zoo, we provide (links to) pre-compiled artifacts in edgeai-modelzoo/modelartifacts. If you would like to use these pre-compiled compiled artifacts and only do inference, then you can create a symbolic link called modelartifacts to edgeai-modelzoo/modelartifacts under ./work_dirs of this repository (remove the modelartifacts folder under ./work_dirs before that).
* While running this script, compilation of models in the model zoo will be performed as the first step before the inference. But if the pre-compiled model artifacts are present, model compilation will be skipped. 
* param.yaml file present in each model artifacts folder indicates that the model compilation is complete.
* **result.yaml file, if present in each model artifacts folder indicates that the model inference is complete. If result.yaml is present, inference is also skipped. Manually delete result.yaml if it is present (i.e. if you have done it once already) to do the inference - otherwise, the script will merely print the result information from result.yaml.**


## Compiling with a custom model or custom configuration
To compile a custom model or a custom pipeline configuration, first, compose a custom configuration in `/scripts/benchmark_custom.py`.
* For a simple example of setting up a custom pipeline configuration, reference `/tutorials/tutorial_classification.ipynb` or `/tutorials/tutorial_detection.ipynb`.

Next, launch the custom configuration by calling 
```
run_custom_pc.sh <SOC> [-d|--debug] [-h|--help]
```

## Generating reports
A consolidated CSV report containing all your benchmarking results can be generated by running [run_generate_report.sh](../run_generate_report.sh)
```
run_generate_report.sh [-d|--debug] [-h|--help]
```

## Packing the artifacts to be used for inferece in the EVM
* The imported artifacts can be used to run inference on the target device (eg. EVM)
* If you have compiled models yourself and would like to run those model artifacts in the target device, run the script 
[run_package_artifacts_for_evm.sh](../run_package_artifacts_for_evm.sh) to package the artifacts for use in the target device.
```
run_package_artifacts_for_evm.sh <SOC> [-d|--debug] [-h|--help]
```
* These packaged artifacts can be copied to the device to run inference there.
* Please note the above comment about result.yaml. These result files are removed while packaing the artifact to be used in EVM (as we actually want to run the inference in EVM). Instead of using the packaging script, you can use the compiled model artifact directory as well, but be sure to remove the result.yaml if you actually want the inference to run.
* Change the modelartifacts_path in settings.yaml to point to the correct modelartifacts path. For example, after packaging, the packaged folder name will be <SOC>_package. To use this packaged artifacts, set modelartifacts_path accordingly.
* As explained above, once the inference is run a result.yaml file is created inside the folder for the model. Any subsequent inference will not run the actual inference, but will just report the result in that file. Delete that result.yaml file if you wish to run the inference again.


## Running inference on EVM or StarterKit board
* Boot the EVM or StarterKit board using an SD card flashed with Edge AI SDK. Connect to the Linux OS in the EVM using ssh or using UART connection.
* Mount or copy the edgeai-benchmark folder on to the EVM. Mount edgeai-modelzoo repository in EVM inside the same folder where edgeai-benchmark is present. Instead of munting these separately, you can also mount the parent folder of edgeai-benchmark as well.
* Copying datasets and compiled artifacts to EVM can be time consuming and can use significant disk space (which may not be available on the EVM). To run on EVM, we recommend to share your the datasets and work_dirs folders in your PC to the EVM and using NFS. [exportfs](https://www.tutorialspoint.com/unix_commands/exportfs.htm) can be used for this NFS sharing.
* Mount the datasets from your PC at the required location in EVM (edgeai-benchmark/dependencies/datasets)
* **Remove result.yaml files from all the folders in the artifacts folders that we are interested in, i.e. in sub-directories inside workdirs/modelartifacts/<SOC>**
* Now the benchmark script can be run on EVM:
```
run_benchmarks_evm.sh <SOC>
```
For example:
```
run_benchmarks_evm.sh AM68A
```
* run_generate_report.sh can be used to gather the results after running.

## Debugging
To debug the python scripts in `/scripts/`, which are called from the top level bash scripts, use `debugpy`'s attach capability. 

For all bash scripts with `debugpy` launching supported, use `./<SCRIPT.sh> --debug` to enable debugging. Then, for every call of a python script, `debugpy` will wait for a debugger to attach to the process. 

To see which scripts are `debugpy` enabled, use the `--help` flag to see if `--debug` is supported.

### Attaching with VSCode
1. Ensure that the [Python](https://marketplace.visualstudio.com/items?itemName=ms-python.python) and [Python Debugger](https://marketplace.visualstudio.com/items?itemName=ms-python.debugpy) extensions are installed
2. Create a debug `launch.json` configuration similar to the following, filling out `<HOSTNAME>`:
```
"configurations": [
    {
        "name": "Python: Remote Attach",
        "type": "debugpy",
        "request": "attach",
        "connect": {
            "host": "<HOSTNAME>",
            "port": 5678
        },
        "justMyCode": false

    },
]
```

See [here](https://code.visualstudio.com/docs/python/debugging#_example) for more information about debugpy in VSCode.

### Attaching with other IDEs
Users of other IDEs must research how to attach a debugpy client in the IDE of their choice. 
